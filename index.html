<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendar și Planificator Concedii</title>

  <!-- PWA manifest + theme -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Calendar">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">

  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --light-bg: #f5f5f5;
      --border-color: #ddd;
      --workday-color: #e6f7ff;
      --holiday-color: #ffcccc;
      --leave-color: #ccffcc;
      --day-off-color: #ffebcc;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background-color: var(--light-bg);
      margin: 0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    h1 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    @media (min-width: 768px) {
      .app-container {
        flex-direction: row;
      }
      
      .calendar-section, .planner-section {
        flex: 1;
      }
    }
    
    .section {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: var(--primary-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }
    
    /* Calendar Styles */
    table { 
      border-collapse: collapse; 
      width: 100%; 
    }
    
    th, td {
      border: 1px solid var(--border-color);
      padding: 8px;
      width: 14%;
      text-align: center;
      cursor: pointer;
    }
    
    th { 
      background-color: #f2f2f2; 
    }
    
    .doy0, .doy1 { 
      background-color: lightyellow; 
    }
    
    .doy2 { 
      background-color: #aaffaa; 
    }
    
    .doy3 { 
      background-color: #aaaaff; 
    }
    
    .doy4 { 
      background-color: var(--leave-color); 
    }
    
    .controls {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .year-btn {
      padding: 5px 10px; 
      margin: 0 5px; 
      cursor: pointer;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: white;
    }
    
    .year-btn.active {
      font-weight: bold;
      background-color: var(--primary-color);
      color: white;
    }
    
    .holiday-buttons {
      margin: 10px 0;
      text-align: center;
    }
    
    .holiday-btn {
      padding: 8px 15px;
      margin: 0 5px;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .holiday-btn:hover { 
      background-color: #e0e0e0; 
    }
    
    .holiday-result {
      margin: 10px 0;
      padding: 10px;
      background-color: #f9f9f9;
      color: #5555aa;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
      min-height: 20px;
    }
    
    #selectedMonth {
      font-weight: bold;
      font-size: 24px;
      color: #55aaaa;
      margin: 15px 0;
      text-align: center;
    }
    
    .user-info {
      margin-bottom: 10px;
      padding: 10px;
      background-color: #f0f8ff;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
      color: #555;
    }
    
    /* Planner Styles */
    .planner-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin: 20px 0;
    }
    
    .day {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: center;
      cursor: pointer;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .day.workday {
      background-color: var(--workday-color);
    }
    
    .day.holiday {
      background-color: var(--holiday-color);
    }
    
    .day.leave {
      background-color: var(--leave-color);
    }
    
    .day.day-off {
      background-color: var(--day-off-color);
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .shift-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    
    #switch-shift {
      padding: 8px 15px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    
    #shift {
      font-weight: bold;
      color: var(--secondary-color);
    }
    
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border: 1px solid var(--border-color);
    }
    
    .tab-container {
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      background-color: #f0f0f0;
    }
    
    .tab.active {
      background-color: white;
      border-color: var(--border-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      padding: 15px 0;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Calendar și Planificator Concedii</h1>
      <div id="userInfo" class="user-info"></div>
    </header>
    
    <div class="tab-container">
      <div class="tabs">
        <div class="tab active" data-tab="calendar">Calendar</div>
        <div class="tab" data-tab="planner">Planificator Concedii</div>
      </div>
    </div>
    
    <div class="app-container">
      <!-- Calendar Section -->
      <div class="section calendar-section tab-content active" id="calendar-tab">
        <div class="section-title">Calendar Schimburi</div>
        
        <div class="controls">
          <div id="yearButtons"></div>
          <select id="monthSelect"></select>
        </div>

        <div class="holiday-buttons">
          <button class="holiday-btn" onclick="checkHoliday('lless')">L&lt</button>
          <button class="holiday-btn" onclick="checkHoliday('lcrt')">Acum</button>
          <button class="holiday-btn" onclick="checkHoliday('lurm')">Luna urm</button>
          <button class="holiday-btn" onclick="checkHoliday('lgrt')">L&gt</button>
          <button class="holiday-btn" onclick="checkHoliday('curm')">C urm</button>
          <button class="holiday-btn" onclick="checkHoliday('paste')">Paște</button>
          <button class="holiday-btn" onclick="checkHoliday('craciun')">Crăciun</button>
          <button class="holiday-btn" onclick="checkHoliday('revelion')">Revelion</button>
        </div>

        <div id="holidayResult" class="holiday-result"></div>
        <div id="selectedMonth"></div>
        <div id="calendarContainer"></div>
      </div>
      
      <!-- Planner Section -->
      <div class="section planner-section tab-content" id="planner-tab">
        <div class="section-title">Planificator Concedii Decembrie 2025</div>
        
        <div class="shift-controls">
          <button id="switch-shift">&#x21C4; Schimbă Tura</button>
          <div id="shift">tura 3</div>
        </div>
        
        <div class="planner-calendar">
          <!-- Days will be dynamically inserted here by JavaScript -->
        </div>
        
        <div class="stats">
          <div class="stat-item">
            <div>Total Ore</div>
            <div class="stat-value" id="total-hours">0</div>
          </div>
          <div class="stat-item">
            <div>Zile Concediu</div>
            <div class="stat-value" id="leave-days">0</div>
          </div>
          <div class="stat-item">
            <div>Obiectiv</div>
            <div class="stat-value">164</div>
          </div>
        </div>
        
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--workday-color);"></div>
            <span>Zi lucrată</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--holiday-color);"></div>
            <span>Sărbătoare/Weekend</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--leave-color);"></div>
            <span>Concediu</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--day-off-color);"></div>
            <span>Repaus</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });
    });

    // Calendar functionality
    const monthNamesRo = ["ianuarie","februarie","martie","aprilie","mai","iunie","iulie","august","septembrie","octombrie","noiembrie","decembrie"];
    let currentYear = new Date().getFullYear();
    let selectedYear = currentYear;
    let selectedMonth = new Date().getMonth();
    let leaveDays = [];

    function handleUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('user')) localStorage.setItem('user', urlParams.get('user'));
      if (urlParams.has('tura')) localStorage.setItem('tura', urlParams.get('tura'));
      updateUserInfo();
    }

    function updateUserInfo() {
      const storedUser = localStorage.getItem('user');
      const storedTura = localStorage.getItem('tura');
      const userInfoElement = document.getElementById('userInfo');
      if (storedUser || storedTura) {
        let info = 'Configurare: ';
        if (storedUser) info += `Utilizator: ${storedUser} `;
        if (storedTura) info += `Tură: ${storedTura}`;
        userInfoElement.textContent = info;
        userInfoElement.style.display = 'block';
      } else {
        userInfoElement.textContent = 'Eroare!';
        userInfoElement.style.display = 'block';
      }
    }

    function getTuraFromUrl() {
      let tura = 2;
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("tura")) {
        tura = parseInt(urlParams.get("tura"));
      } else if (urlParams.has("user")) {
        const users = ["ljc1q", "xxtoo", "fras0", "l3hb4"];
        const idx = users.indexOf(urlParams.get("user"));
        if (idx >= 0) tura = idx + 1;
      } else {
        const storedTura = localStorage.getItem('tura');
        const storedUser = localStorage.getItem('user');
        if (storedTura) {
          tura = parseInt(storedTura);
        } else if (storedUser) {
          const users = ["ljc1q", "xxtoo", "fras0", "l3hb4"];
          const idx = users.indexOf(storedUser);
          if (idx >= 0) tura = idx + 1;
        }
      }
      if (tura % 2 === 0) tura = 6 - tura;
      return tura;
    }

    function isPWA() {
      return window.navigator.standalone === true || 
             window.matchMedia('(display-mode: standalone)').matches ||
             window.matchMedia('(display-mode: fullscreen)').matches;
    }

    function createYearButtons() {
      const yearButtonsContainer = document.getElementById('yearButtons');
      yearButtonsContainer.innerHTML = '';
      for (let year = currentYear - 3; year <= currentYear + 2; year++) {
        const button = document.createElement('button');
        button.className = 'year-btn';
        if (year === selectedYear) button.classList.add('active');
        button.textContent = year;
        button.onclick = function () {
          selectedYear = year;
          saveToLocalStorage();
          updateYearButtons();
          document.getElementById("holidayResult").innerHTML = ``;
          updateCalendar();
        };
        yearButtonsContainer.appendChild(button);
      }
    }

    function updateYearButtons() {
      const buttons = document.querySelectorAll('.year-btn');
      buttons.forEach(button => {
        if (parseInt(button.textContent) === selectedYear)
          button.classList.add('active');
        else
          button.classList.remove('active');
      });
    }

    function populateMonthSelect() {
      const monthSelect = document.getElementById('monthSelect');
      monthSelect.innerHTML = '';
      for (let month = 0; month < 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = monthNamesRo[month];
        if (month === selectedMonth) option.selected = true;
        monthSelect.appendChild(option);
      }
      monthSelect.addEventListener('change', function () {
        selectedMonth = parseInt(monthSelect.value);
        saveToLocalStorage();
        document.getElementById("holidayResult").innerHTML = ``;
        updateCalendar();
      });
    }

    function loadFromLocalStorage() {
      const storedYear = localStorage.getItem('selectedYear');
      const storedMonth = localStorage.getItem('selectedMonth');
      const storedLeaveDays = localStorage.getItem('leaveDays');
      
      if (storedYear) selectedYear = parseInt(storedYear);
      if (storedMonth) selectedMonth = parseInt(storedMonth);
      if (storedLeaveDays) leaveDays = JSON.parse(storedLeaveDays);
    }

    function saveToLocalStorage() {
      localStorage.setItem('selectedYear', selectedYear);
      localStorage.setItem('selectedMonth', selectedMonth);
      localStorage.setItem('leaveDays', JSON.stringify(leaveDays));
    }

    function initializeControls() {
      handleUrlParams();
      loadFromLocalStorage();
      createYearButtons();
      populateMonthSelect();
      if (!isPWA()) {
        const urlParams = new URLSearchParams(window.location.search);
        const storedUser = localStorage.getItem('user');
        const storedTura = localStorage.getItem('tura');
        let urlChanged = false;
        if (storedUser && !urlParams.has('user')) { urlParams.set('user', storedUser); urlChanged = true; }
        if (storedTura && !urlParams.has('tura')) { urlParams.set('tura', storedTura); urlChanged = true; }
        if (urlChanged) {
          const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
          window.history.replaceState({}, '', newUrl);
        }
      }
    }

    function toggleLeaveDay(year, month, day) {
      const dateKey = `${year}-${month}-${day}`;
      const index = leaveDays.indexOf(dateKey);
      
      if (index === -1) {
        leaveDays.push(dateKey);
      } else {
        leaveDays.splice(index, 1);
      }
      
      saveToLocalStorage();
      updateCalendar();
    }

    function updateCalendar() {
      const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
      const firstDay = (new Date(selectedYear, selectedMonth, 1).getDay() + 6) % 7;
      let tura = getTuraFromUrl();
      const date0 = new Date(2017, 0, 1);
      let fakeDayOfYear = Math.ceil((new Date(selectedYear, selectedMonth, 1) - date0) / 86400000);
      
      let html = `<table><tr><th>lun</th><th>mar</th><th>mie</th><th>joi</th><th>vin</th><th>sâm</th><th>dum</th></tr><tr>`;
      let dayCount = 1;
      
      for (let i = 0; i < 42; i++) {
        if (i >= firstDay && dayCount <= daysInMonth) {
          const dateKey = `${selectedYear}-${selectedMonth}-${dayCount}`;
          const isLeaveDay = leaveDays.includes(dateKey);
          
          let dayClass = isLeaveDay ? 'doy4' : `doy${(fakeDayOfYear + tura) % 4}`;
          
          html += `<td class="${dayClass}" data-day="${dayCount}">${dayCount}</td>`;
          fakeDayOfYear++; 
          dayCount++;
        } else {
          html += `<td></td>`;
        }
        
        if (i % 7 === 6 && dayCount <= daysInMonth) html += `</tr><tr>`;
        if (dayCount > daysInMonth && i % 7 === 6) break;
      }
      
      html += `</tr></table>`;
      document.getElementById("calendarContainer").innerHTML = html;
      
      const ldcount = leaveDays.length;
      const currentMonth = `${selectedYear}-${selectedMonth}-`;
      const currentmlc = leaveDays.filter(day => day.startsWith(currentMonth)).length;
      const mlc2 = ldcount ? `(${currentmlc}/${ldcount})`: ``;
      document.getElementById("selectedMonth").innerHTML = `Calendar ${monthNamesRo[selectedMonth]} ${selectedYear} ${mlc2}`;
      
      const dayCells = document.querySelectorAll('#calendarContainer td[data-day]');
      dayCells.forEach(cell => {
        cell.addEventListener('click', function() {
          const day = parseInt(this.getAttribute('data-day'));
          toggleLeaveDay(selectedYear, selectedMonth, day);
        });
      });
    }

    function getEasterDate(year) {
      const a = year % 4, b = year % 7, c = year % 19;
      const d = (19 * c + 15) % 30;
      const e = (2 * a + 4 * b - d + 34) % 7;
      const month = Math.floor((d + e + 114) / 31);
      const day = ((d + e + 114) % 31) + 1;
      let date = new Date(year, month - 1, day);
      date.setDate(date.getDate() + 13);
      return date;
    }

    function getDayName(date) {
      const days = ['duminică', 'luni', 'marți', 'miercuri', 'joi', 'vineri', 'sâmbătă'];
      return days[date.getDay()];
    }

    function findClosestWorkShift(holidayDate, tura) {
      const date0 = new Date(2024, 0, 1);
      let closest = null, minDistance = Infinity;
      for (let offset = -10; offset <= 10; offset++) {
        let d = new Date(holidayDate);
        d.setDate(d.getDate() + offset);
        const daysDiff = Math.ceil((d - date0) / 86400000);
        const shift = (daysDiff + tura) % 4;
        if (shift === 2 || shift === 3) {
          let dist = Math.abs(offset);
          if (dist < minDistance) {
            minDistance = dist;
            closest = {
              date: d,
              shift: shift === 2 ? 'de zi' : 'de noapte',
              dayName: getDayName(d)
            };
          }
        }
      }
      return closest;
    }

    function checkHoliday(type) {
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const tura = getTuraFromUrl();
      let date, name = '';
      
      if (type === "lcrt") { 
        date = new Date(); 
      } else if (type === "lless") { 
        date = new Date(selectedYear, selectedMonth - 1, new Date().getDate()); 
      } else if (type === "lgrt") {
        date = new Date(selectedYear, selectedMonth + 1, new Date().getDate());
        if (date.getFullYear() > currentYear + 2) date = new Date(currentYear + 2, 11, new Date().getDate());
      } else if (type === "lurm") { 
        date = new Date(currentYear, new Date().getMonth() + 1, 15); 
      } else if (type === "curm") {
        date = new Date(selectedYear, selectedMonth, 15);
        if (leaveDays) {
          while (true) {
            date = new Date(date.getFullYear(), date.getMonth() + 1, 15);
            if (date.getFullYear() > currentYear + 2) {
              date = new Date(currentYear - 1, 0, 15);
            }
            if (date.getFullYear() === selectedYear && date.getMonth() === selectedMonth) {
              break;
            }
            const currentMonth = `${date.getFullYear()}-${date.getMonth()}-`;
            const currentmlc = leaveDays.filter(day => day.startsWith(currentMonth)).length;
            if (currentmlc) break;  
          }
        }
      } else {
        for (let year = currentYear; year <= currentYear + 10; year++) {
          if (type === 'paste') { 
            date = getEasterDate(year); 
            name = 'Paște'; 
          } else if (type === 'craciun') { 
            date = new Date(year, 11, 25); 
            name = 'Crăciun'; 
          } else if (type === 'revelion') { 
            date = new Date(year, 0, 1); 
            name = 'Revelion'; 
          }
          if (date > currentDate) break;
        }
      }
      
      const closest = findClosestWorkShift(date, tura);
      if (closest) {
        const m = monthNamesRo[closest.date.getMonth()];
        const y = closest.date.getFullYear();
        const d = closest.date.getDate();
        const text = `De ${name} ${y} sunt ${closest.shift} ${closest.dayName}, ${d} ${m} ${y}`;
        if (name) {
          document.getElementById('holidayResult').textContent = text;
        } else {
          document.getElementById("holidayResult").innerHTML = ``;
        }
        selectedYear = y;
        selectedMonth = closest.date.getMonth();
      }
      
      saveToLocalStorage();
      updateYearButtons();
      populateMonthSelect();
      updateCalendar();
    }

    // Planner functionality
    class RomanianHolidays {
      constructor() {
        this.baseUrl = 'https://date.nager.at/api/v3';
      }

      // Get all holidays for a year
      async getHolidays(year = new Date().getFullYear()) {
        try {
          const response = await fetch(`${this.baseUrl}/PublicHolidays/${year}/RO`);
          if (!response.ok) throw new Error('Network response was not ok');
          return await response.json();
        } catch (error) {
          console.error('Error fetching holidays:', error);
          return null;
        }
      }

      // Check if a specific date is a holiday
      async isHoliday(date = new Date()) {
        const year = date.getFullYear();
        const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD
        
        const holidays = await this.getHolidays(year);
        if (!holidays) return false;

        return holidays.some(holiday => holiday.date === dateString);
      }

      // Get upcoming holidays
      async getUpcomingHolidays(count = 5) {
        const currentYear = new Date().getFullYear();
        const holidays = await this.getHolidays(currentYear);
        
        if (!holidays) return [];

        const today = new Date().toISOString().split('T')[0];
        
        return holidays
          .filter(holiday => holiday.date >= today)
          .slice(0, count);
      }

      // Get holidays for multiple years
      async getHolidaysRange(startYear, endYear) {
        const years = Array.from({ length: endYear - startYear + 1 }, (_, i) => startYear + i);
        const promises = years.map(year => this.getHolidays(year));
        
        try {
          const results = await Promise.all(promises);
          return results.flat();
        } catch (error) {
          console.error('Error fetching holiday range:', error);
          return null;
        }
      }
    }

    const daysInDecember = 31;
    // Remove hardcoded holidays and calculate them dynamically
    let holidays = [];
    const saturdays = [6, 13, 20, 27];
    const sundays = [7, 14, 21, 28];
    const normalDayshifts = [4, 8, 12, 16, 20, 24, 28];
    const normalNightshifts = [1, 5, 9, 13, 17, 21, 25, 29];
    const hoursPerWorkedDay = 12;
    const hoursPerLeaveDay = 8;
    const goalHours = 164;
    let totalHours = 0;
    let leaveDaysPlanner = 0;
    const calendar = document.querySelector(".planner-calendar");
    const totalHoursDisplay = document.getElementById("total-hours");
    const leaveDaysDisplay = document.getElementById("leave-days");
    let turaPlanner = 3;

    // Initialize holiday service
    const holidayService = new RomanianHolidays();

    // Function to get December holidays for a specific year
    async function getDecemberHolidays(year = 2025) {
      try {
        const allHolidays = await holidayService.getHolidays(year);
        if (!allHolidays) {
          console.warn('Could not fetch holidays, using fallback');
          return [1, 25, 26]; // Fallback to hardcoded values
        }
        
        // Filter holidays that are in December and extract the day
        const decemberHolidays = allHolidays
          .filter(holiday => {
            const month = parseInt(holiday.date.split('-')[1]);
            return month === 12;
          })
          .map(holiday => parseInt(holiday.date.split('-')[2]));
        
        console.log('December holidays:', decemberHolidays);
        return decemberHolidays;
      } catch (error) {
        console.error('Error getting December holidays:', error);
        return [1, 25, 26]; // Fallback to hardcoded values
      }
    }

    async function updateHolidays() {
      holidays = await getDecemberHolidays(2025);
    }

    function updateStats() {
      totalHoursDisplay.textContent = totalHours;
      leaveDaysDisplay.textContent = leaveDaysPlanner;
      document.getElementById("shift").innerHTML = `tura ${turaPlanner}`;
    }

    async function renderPlanner() {
      // Update holidays before rendering
      await updateHolidays();
      
      calendar.innerHTML = ``;
      totalHours = 0;
      leaveDaysPlanner = 0;
      
      for (let day = 1; day <= daysInDecember; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("day");
        dayElement.textContent = day;
        
        // Determine initial day type
        if (holidays.includes(day) || saturdays.includes(day) || sundays.includes(day)) {
          dayElement.classList.add("holiday");
        }
	if ((day + 7 - turaPlanner) % 4 < 2) {
          dayElement.classList.add("workday");
          totalHours += hoursPerWorkedDay;
        } else {
          dayElement.classList.add("day-off");
        }
        
        dayElement.addEventListener("click", () => toggleDayStatus(dayElement, day));
        calendar.appendChild(dayElement);
      }
      updateStats();
    }

    document.getElementById("switch-shift").addEventListener("click", () => {
      turaPlanner++;
      if (turaPlanner === 5) turaPlanner = 1;
      renderPlanner();
    });

    function toggleDayStatus(dayElement, day) {
      const isHoliday = holidays.includes(day) || saturdays.includes(day) || sundays.includes(day);
      const isWorkDay = (day + 7 - turaPlanner) % 4 < 2;
      
      if (isWorkDay) {
        if (dayElement.classList.contains("workday")) {
          dayElement.classList.remove("workday");
          dayElement.classList.add("leave");
          totalHours -= hoursPerWorkedDay;
          leaveDaysPlanner += 1;
        } else if (dayElement.classList.contains("leave")) {
          dayElement.classList.remove("leave");
          dayElement.classList.add("workday");
          totalHours += hoursPerWorkedDay;
          leaveDaysPlanner -= 1;
        }
      } else {
        if (isHoliday) {
          if (dayElement.classList.contains("leave")) {
            dayElement.classList.remove("leave");
            leaveDaysPlanner -= 1;
          } else {
            dayElement.classList.add("leave");
            leaveDaysPlanner += 1;
          }
        } else {
          if (dayElement.classList.contains("leave")) {
            dayElement.classList.remove("leave");
            totalHours -= hoursPerLeaveDay;
            leaveDaysPlanner -= 1;
          } else {
            dayElement.classList.add("leave");
            totalHours += hoursPerLeaveDay;
            leaveDaysPlanner += 1;
          }
        }
      }
      updateStats();
    }

    // Initialize both apps
    window.addEventListener('load', function() {
      initializeControls();
      updateCalendar();
      renderPlanner();
    });

    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) updateUserInfo();
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register("sw.js");
      });
    }
  </script>
</body>
</html>
